// 🌟 AURA CORE FILES - Copy & paste these into your project!

// ============================================
// 1. src/types/aura.ts
// ============================================
export interface AuraMessage {
  id: string;
  content: string;
  role: 'user' | 'aura';
  timestamp: Date;
  emotion?: EmotionState;
  proactiveSuggestions?: ProactiveSuggestion[];
}

export interface EmotionState {
  primary: 'happy' | 'excited' | 'curious' | 'frustrated' | 'calm' | 'stressed';
  confidence: number; // 0-1
  context?: string;
}

export interface ProactiveSuggestion {
  id: string;
  type: 'reminder' | 'suggestion' | 'insight' | 'action';
  title: string;
  description: string;
  priority: 'low' | 'medium' | 'high';
  action?: () => void;
}

export interface UserContext {
  location?: string;
  timeOfDay: 'morning' | 'afternoon' | 'evening' | 'night';
  deviceContext: {
    battery?: number;
    connectivity: 'online' | 'offline' | 'slow';
    isMoving?: boolean;
  };
  recentActivity?: string[];
  mood?: EmotionState;
}

// ============================================
// 2. src/lib/aura/emotions.ts
// ============================================
export class EmotionAnalyzer {
  analyzeText(text: string): EmotionState {
    const emotions = {
      happy: /great|awesome|amazing|love|perfect|wonderful|fantastic/i,
      excited: /excited|can't wait|let's go|amazing|incredible|wow/i,
      curious: /how|what|why|tell me|explain|interesting|curious/i,
      frustrated: /frustrated|annoying|problem|stuck|help|difficult/i,
      calm: /okay|fine|good|nice|peaceful|relaxed/i,
      stressed: /stressed|overwhelmed|busy|tired|pressure|deadline/i
    };

    let maxScore = 0;
    let detectedEmotion: EmotionState['primary'] = 'calm';

    for (const [emotion, pattern] of Object.entries(emotions)) {
      const matches = (text.match(pattern) || []).length;
      if (matches > maxScore) {
        maxScore = matches;
        detectedEmotion = emotion as EmotionState['primary'];
      }
    }

    return {
      primary: detectedEmotion,
      confidence: Math.min(maxScore * 0.3 + 0.5, 1),
      context: `Detected from: "${text.substring(0, 50)}..."`
    };
  }

  getEmotionalResponse(emotion: EmotionState): string {
    const responses = {
      happy: "I can sense your positive energy! 😊",
      excited: "Your excitement is contagious! Let's make something amazing happen! 🚀",
      curious: "I love your curiosity! Let me help you explore this further. 🤔",
      frustrated: "I can tell you're feeling stuck. Let me help you work through this step by step. 💪",
      calm: "You seem centered and focused. Perfect time for productive work! 🧘",
      stressed: "I notice you might be feeling overwhelmed. Let's break this down into manageable pieces. 🌱"
    };

    return responses[emotion.primary] || "I'm here to help however I can! 💫";
  }
}

// ============================================
// 3. src/lib/aura/patterns.ts
// ============================================
export class PatternRecognizer {
  private userPatterns: Map<string, any> = new Map();

  recordInteraction(userId: string, interaction: {
    type: string;
    context: UserContext;
    timestamp: Date;
    response?: string;
  }) {
    if (!this.userPatterns.has(userId)) {
      this.userPatterns.set(userId, {
        interactions: [],
        preferences: {},
        patterns: {}
      });
    }

    const userPattern = this.userPatterns.get(userId);
    userPattern.interactions.push(interaction);
    
    // Keep only last 100 interactions for performance
    if (userPattern.interactions.length > 100) {
      userPattern.interactions.shift();
    }
  }

  generateProactiveSuggestions(userId: string, currentContext: UserContext): ProactiveSuggestion[] {
    const suggestions: ProactiveSuggestion[] = [];
    
    // Time-based suggestions
    if (currentContext.timeOfDay === 'morning') {
      suggestions.push({
        id: 'morning-briefing',
        type: 'insight',
        title: '🌅 Good Morning!',
        description: 'Ready for your daily briefing? I can help prioritize your day.',
        priority: 'medium'
      });
    }

    // Battery-based suggestions  
    if (currentContext.deviceContext.battery && currentContext.deviceContext.battery < 20) {
      suggestions.push({
        id: 'battery-low',
        type: 'reminder',
        title: '🔋 Battery Running Low',
        description: 'Want me to help you find important tasks to finish before charging?',
        priority: 'high'
      });
    }

    // Context-aware suggestions
    if (currentContext.deviceContext.isMoving) {
      suggestions.push({
        id: 'mobile-mode',
        type: 'suggestion', 
        title: '🚶‍♀️ You\'re On the Move',
        description: 'Perfect time for audio content or quick voice commands!',
        priority: 'medium'
      });
    }

    return suggestions;
  }
}

// ============================================
// 4. src/lib/aura/core.ts
// ============================================
import { EmotionAnalyzer } from './emotions';
import { PatternRecognizer } from './patterns';
import { AuraMessage, UserContext, ProactiveSuggestion } from '@/types/aura';

export class AuraCore {
  private emotionAnalyzer: EmotionAnalyzer;
  private patternRecognizer: PatternRecognizer;
  private userId: string;

  constructor(userId: string = 'default') {
    this.userId = userId;
    this.emotionAnalyzer = new EmotionAnalyzer();
    this.patternRecognizer = new PatternRecognizer();
  }

  async processMessage(
    message: string,
    context: UserContext
  ): Promise<{
    response: AuraMessage;
    proactiveSuggestions: ProactiveSuggestion[];
  }> {
    // Analyze emotions
    const emotion = this.emotionAnalyzer.analyzeText(message);
    
    // Generate emotional response
    const emotionalPrefix = this.emotionAnalyzer.getEmotionalResponse(emotion);
    
    // Generate contextual response
    const contextualResponse = await this.generateContextualResponse(message, context);
    
    // Combine responses
    const fullResponse = `${emotionalPrefix} ${contextualResponse}`;
    
    // Record interaction
    this.patternRecognizer.recordInteraction(this.userId, {
      type: 'message',
      context,
      timestamp: new Date(),
      response: fullResponse
    });
    
    // Generate proactive suggestions
    const proactiveSuggestions = this.patternRecognizer.generateProactiveSuggestions(
      this.userId, 
      context
    );

    const response: AuraMessage = {
      id: `aura_${Date.now()}`,
      content: fullResponse,
      role: 'aura',
      timestamp: new Date(),
      emotion,
      proactiveSuggestions
    };

    return {
      response,
      proactiveSuggestions
    };
  }

  private async generateContextualResponse(message: string, context: UserContext): Promise<string> {
    const lowerMessage = message.toLowerCase();
    
    // Context-aware responses
    if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
      const timeGreeting = this.getTimeBasedGreeting(context.timeOfDay);
      return `${timeGreeting} I'm Aura, your proactive AI assistant. I don't just wait for commands - I anticipate your needs and help orchestrate your day. What can I help you accomplish?`;
    }
    
    if (lowerMessage.includes('how') && lowerMessage.includes('work')) {
      return "I work by continuously learning your patterns and predicting your needs. I analyze your emotions, context, and habits to provide proactive suggestions before you even ask. Want me to show you?";
    }
    
    if (lowerMessage.includes('privacy') || lowerMessage.includes('data')) {
      return "Privacy is my foundation! I process everything locally on your device when possible. Your personal data stays yours - I just help you organize and optimize it. Full transparency and control!";
    }
    
    if (lowerMessage.includes('proactive') || lowerMessage.includes('predict')) {
      return "That's my superpower! I observe patterns in your behavior, learn your preferences, and predict what you'll need next. For example, I might remind you about traffic before you leave, or suggest breaking when I detect stress patterns.";
    }
    
    // Default intelligent response
    return "I understand what you're asking. As your AI life assistant, I'm analyzing our conversation to better understand how to help you. Each interaction teaches me more about your communication style and needs.";
  }

  private getTimeBasedGreeting(timeOfDay: string): string {
    const greetings = {
      morning: "Good morning! ☀️",
      afternoon: "Good afternoon! 🌤️", 
      evening: "Good evening! 🌅",
      night: "Good evening! 🌙"
    };
    
    return greetings[timeOfDay as keyof typeof greetings] || "Hello! 👋";
  }
}

// ============================================
// 5. src/hooks/useAura.ts  
// ============================================
import { useState, useCallback, useEffect } from 'react';
import { AuraCore } from '@/lib/aura/core';
import { AuraMessage, UserContext, ProactiveSuggestion } from '@/types/aura';

export function useAura() {
  const [messages, setMessages] = useState<AuraMessage[]>([]);
  const [isThinking, setIsThinking] = useState(false);
  const [proactiveSuggestions, setProactiveSuggestions] = useState<ProactiveSuggestion[]>([]);
  const [auraCore] = useState(() => new AuraCore());

  // Get current context
  const getCurrentContext = useCallback((): UserContext => {
    const hour = new Date().getHours();
    let timeOfDay: UserContext['timeOfDay'];
    
    if (hour < 6) timeOfDay = 'night';
    else if (hour < 12) timeOfDay = 'morning'; 
    else if (hour < 18) timeOfDay = 'afternoon';
    else if (hour < 22) timeOfDay = 'evening';
    else timeOfDay = 'night';

    return {
      timeOfDay,
      deviceContext: {
        connectivity: navigator.onLine ? 'online' : 'offline',
        // @ts-ignore - Battery API is experimental
        battery: navigator.getBattery ? undefined : undefined
      }
    };
  }, []);

  // Send message to Aura
  const sendMessage = useCallback(async (content: string) => {
    // Add user message
    const userMessage: AuraMessage = {
      id: `user_${Date.now()}`,
      content,
      role: 'user', 
      timestamp: new Date()
    };
    
    setMessages(prev => [...prev, userMessage]);
    setIsThinking(true);

    try {
      // Process with Aura
      const context = getCurrentContext();
      const result = await auraCore.processMessage(content, context);
      
      // Add Aura response
      setMessages(prev => [...prev, result.response]);
      setProactiveSuggestions(result.proactiveSuggestions);
      
    } catch (error) {
      console.error('Error processing message:', error);
      // Add error message
      const errorMessage: AuraMessage = {
        id: `error_${Date.now()}`,
        content: "I apologize, I'm having trouble processing that right now. Please try again!",
        role: 'aura',
        timestamp: new Date()
      };
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsThinking(false);
    }
  }, [auraCore, getCurrentContext]);

  // Initialize with welcome message
  useEffect(() => {
    const welcomeMessage: AuraMessage = {
      id: 'welcome',
      content: "👋 Hi! I'm Aura, your proactive AI life assistant. I don't just wait for commands - I anticipate your needs and help orchestrate your day. Try asking me something, or just say hello!",
      role: 'aura',
      timestamp: new Date()
    };
    
    setMessages([welcomeMessage]);
  }, []);

  return {
    messages,
    isThinking,
    proactiveSuggestions,
    sendMessage
  };
}